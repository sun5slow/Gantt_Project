<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>My Gantt Project (Final Stable Version)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <link href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css" rel="stylesheet">
    <script src="https://export.dhtmlx.com/gantt/api.js"></script>

    <style>
        html, body { height: 100%; padding: 0; margin: 0; overflow: hidden; font-family: 'Roboto', 'Noto Sans KR', sans-serif; background-color: #f5f5f5; }
        .gantt-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .gantt-controls { padding: 10px; background-color: #ffffff; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .control-group { display: flex; align-items: center; gap: 5px; }
        .gantt-controls button, .gantt-controls select, .gantt-controls input {
            font-family: inherit; font-size: 13px; padding: 5px 12px; border: 1px solid #ced4da;
            border-radius: 4px; background-color: white;
        }
        .gantt-controls button { cursor: pointer; transition: background-color 0.2s; }
        .gantt-controls button:hover { background-color: #f1f3f5; }
        .gantt-controls button.active { background-color: #3498db; color: white; border-color: #3498db; }
        #gantt_here { width: 100%; flex-grow: 1; }
        :root { --gantt-header-background: #ffffff; --gantt-grid-border: #e0e0e0; --gantt-task-bar-color: #5a99d4; --gantt-task-bar-progress-color: #4a88c4; --gantt-project-bar-color: #fad284; --gantt-milestone-color: #d700a4; --gantt-today-marker-color: #ef4444; }
        .gantt_task_content { font-family: 'Roboto', 'Noto Sans KR', sans-serif !important; font-size: 13px !important; }
        .gantt_grid_head_cell { font-weight: 500 !important; background-color: var(--gantt-header-background) !important; }
        .gantt_grid_scale, .gantt_task_scale { background-color: var(--gantt-header-background) !important; }
        .gantt_task_line { background-color: var(--gantt-task-bar-color); border-color: #4a88c4; }
        .gantt_task_progress { background-color: var(--gantt-task-bar-progress-color); }
        .gantt_project { background-color: var(--gantt-project-bar-color); border: none; }
        .gantt_project .gantt_task_progress { background-color: #e3b65b; }
        .gantt_link_arrow { border-color: #555; }
        .gantt_line_wrapper div { background-color: #555; }
        .gantt_milestone { border: none; background-color: var(--gantt-milestone-color); }
        .gantt_milestone .gantt_task_content { display: none; }
        .gantt_today_marker { background-color: var(--gantt-today-marker-color); opacity: 0.2; }
        .gantt_task_line.gantt_critical_task { background-color: #e64747; border-color: #c82d2d; }
        .baseline { position: absolute; border-radius: 2px; background-color: #a8a8a8; opacity: 0.6; height: 8px; z-index: 0; pointer-events: none; }
    </style>
</head>
<body>
    <div class="gantt-container">
        <div class="gantt-controls">
            <div class="control-group">
                <button data-zoom="day" class="active">일</button>
                <button data-zoom="week">주</button>
                <button data-zoom="month">월</button>
                <button data-zoom="year">년</button>
            </div>
            <div class="control-group">
                <button onclick="gantt.ext.criticalPath.toggle()">중요 경로</button>
                <button id="setBaselineBtn">베이스라인 설정</button>
                <select id="compareBaselineSelect"><option value="">베이스라인 비교 안 함</option></select>
            </div>
            <div class="control-group">
                <button onclick="gantt.undo()">되돌리기</button>
                <button onclick="gantt.redo()">다시 실행</button>
            </div>
            <div class="control-group">
                <button onclick="gantt.ext.fullscreen.toggle()">전체화면</button>
                <button onclick="gantt.exportToPNG()">PNG</button>
            </div>
            <div class="control-group">
                <label for="filterInput" style="margin-left: 10px;">이름 검색:</label>
                <input type="text" id="filterInput" placeholder="작업 이름 입력...">
                <label for="assigneeFilter" style="margin-left: 10px;">책임자:</label>
                <select id="assigneeFilter"><option value="">전체</option></select>
            </div>
        </div>
        <div id="gantt_here"></div>
    </div>

    <script>
        gantt.plugins({ 
            fullscreen: true, tooltip: true, critical_path: true, 
            marker: true, export_api: true, drag_timeline: true, undo: true, zoom: true
        });

        gantt.templates.task_text = function (start, end, task) {
            let baselineHTML = '';
            if (task.planned_start && task.planned_end) {
                const planned_start = gantt.date.parseDate(task.planned_start, "xml_date");
                const planned_end = gantt.date.parseDate(task.planned_end, "xml_date");
                if (planned_start && planned_end) {
                    const sizes = gantt.getTaskPosition(task, planned_start, planned_end);
                    baselineHTML = `<div class='baseline' style='left:${sizes.left}px; width:${sizes.width}px; top:${sizes.top + gantt.config.bar_height + 4}px;'></div>`;
                }
            }
            if (task.type === gantt.config.types.project) { return baselineHTML; }
            return task.text + baselineHTML;
        };
        
        gantt.templates.progress_text = function() { return ""; };
        gantt.templates.leftside_text = function(){ return ""; };
        gantt.templates.rightside_text = function(){ return ""; };

        gantt.templates.tooltip_text = function (start, end, task) {
            return `<b>작업:</b> ${task.text}<br/>` +
                   `<b>기간:</b> ${gantt.templates.task_date(start)} - ${gantt.templates.task_date(end)}<br/>` +
                   `<b>진행률:</b> ${Math.round(task.progress * 100)}%<br/>` +
                   `<b>책임자:</b> ${task.assignee || '미지정'}<br/>`+
                   `<b>상태:</b> ${task.status || '미지정'}`;
        };
        
        const zoomConfig = {
            levels: [
                {
                    name: "year", min_column_width: 50,
                    scales: [ {unit: "year", step: 1, format: "%Y년"}, {unit: "quarter", step: 1, format: (date) => { const month = date.getMonth(); if (month < 3) return "Q1"; if (month < 6) return "Q2"; if (month < 9) return "Q3"; return "Q4"; }} ]
                },
                { name: "month", min_column_width: 80, scales: [{unit: "year", step: 1, format: "%Y년"}, {unit: "month", step: 1, format: "%F"}] },
                { name: "week", min_column_width: 80, scales: [{unit: "month", step: 1, format: "%Y년 %F"}, {unit: "week", step: 1, format: (date) => { const dateToStr = gantt.date.date_to_str("%m/%d"); const endDate = gantt.date.add(date, 6, "day"); return `${dateToStr(date)} - ${dateToStr(endDate)}`; }}] },
                { name: "day", min_column_width: 60, scales: [{unit: "month", step: 1, format: "%Y년 %F"}, {unit: "day", step: 1, format: "%j일 (%D)"}] }
            ]
        };
        
        gantt.ext.zoom.init(zoomConfig);
        gantt.ext.zoom.setLevel("day");

        gantt.config.date_format = "%Y-%m-%d";
        gantt.i18n.setLocale("kr");
        gantt.config.round_dnd_dates = true;
        gantt.config.duration_unit = "day";
        gantt.config.work_time = true;
        gantt.config.auto_types = false;
        gantt.config.details_on_dblclick = true;
        gantt.config.sort = true;
        gantt.config.drag_timeline = { ignore: ".gantt_task_line, .gantt_task_link", useKey: "shiftKey" };
        gantt.config.drag_progress = true;

        gantt.config.columns = [
            {name: "text", label: "작업 이름", tree: true, width: 250, resize: true},
            {name: "start_date", label: "시작일", align: "center", width: 110},
            {name: "duration", label: "기간", align: "center", width: 60},
            {name: "end_date", label: "종료일", align: "center", width: 110},
            {name: "assignee", label: "책임자", align: "center", width: 80, resize: true, template: (task) => task.assignee || ""},
            {name: "add", width: 44}
        ];
        gantt.config.grid_width = 650;
        gantt.config.grid_resize = true;

        gantt.config.lightbox.sections = [
            {name: "description", height: 70, map_to: "text", type: "textarea", focus: true},
            {name: "type", map_to: "type", type: "typeselect"},
            {name: "assignee", height: 22, map_to: "assignee", type: "text"},
            {name: "status", height: 22, map_to: "status", type: "select", options: [{key: "대기", label: "대기"}, {key: "진행 중", label: "진행 중"}, {key: "완료", label: "완료"}]},
            {name: "period", type: "time", map_to: "auto"}
        ];

        gantt.locale.labels.section_description = "작업 이름";
        gantt.locale.labels.section_type = "타입";
        gantt.locale.labels.section_assignee = "책임자";
        gantt.locale.labels.section_status = "상태";
        gantt.locale.labels.section_period = "기간";

        let taskJustChangedToProject = null;

        gantt.attachEvent("onLightboxSave", function(id, task, is_new) {
            const originalTask = gantt.getTask(id);
            const originalType = originalTask ? originalTask.type : "";

            if (task.type === gantt.config.types.milestone) {
                task.end_date = task.start_date;
            }

            // [최종 해결책] 타입이 '프로젝트'로 변경되는 경우를 감지
            if (!is_new && task.type === gantt.config.types.project && originalType !== task.type) {
                taskJustChangedToProject = id; // 플래그 설정
                
                // 1. 라이트박스의 값으로 Gantt 데이터 객체를 수동 업데이트
                const taskToUpdate = gantt.getTask(id);
                Object.assign(taskToUpdate, task);
                gantt.updateTask(id);

                // 2. 라이트박스를 수동으로 숨김
                gantt.hideLightbox();
                
                // 3. Gantt의 기본 동작(오류 유발)을 차단
                return false; 
            }

            return true;
        });
        
        let todayMarkerId;
        gantt.attachEvent("onGanttReady", function(){
            if(todayMarkerId) gantt.deleteMarker(todayMarkerId);
            const today = new Date();
            todayMarkerId = gantt.addMarker({ start_date: today, css: "today", text: "오늘" });
        });

        gantt.init("gantt_here");

        const dp = gantt.createDataProcessor(function (entity, action, data, id) {
            const prefix = "/api";
            switch (action) {
                case "create": return gantt.ajax.post(`${prefix}/${entity}`, data);
                case "update": return gantt.ajax.put(`${prefix}/${entity}/${id}`, data);
                case "delete": return gantt.ajax.del(`${prefix}/${entity}/${id}`);
            }
        });
        dp.init(gantt);
        
        // [최종 해결책] 서버 업데이트 후, 안전한 새로고침 실행
        dp.attachEvent("onAfterUpdate", function(id, action, tid, response){
            if (taskJustChangedToProject === tid) {
                gantt.clearAll();
                gantt.load("/api/data");
                gantt.message("프로젝트로 변경되어 차트를 새로고침합니다.");
                taskJustChangedToProject = null; // 플래그 초기화
            }
        });


        gantt.load("/api/data");

        document.querySelectorAll(".gantt-controls button[data-zoom]").forEach(button => {
            button.addEventListener("click", function() {
                const zoomLevel = this.dataset.zoom;
                gantt.ext.zoom.setLevel(zoomLevel);
                document.querySelectorAll(".gantt-controls button[data-zoom]").forEach(btn => btn.classList.remove("active"));
                this.classList.add("active");
            });
        });

        const filterInput = document.getElementById("filterInput");
        const assigneeFilter = document.getElementById("assigneeFilter");
        let filterTimeout;
        function applyFilters() { gantt.render(); }
        filterInput.addEventListener("keyup", () => { clearTimeout(filterTimeout); filterTimeout = setTimeout(applyFilters, 500); });
        assigneeFilter.addEventListener("change", applyFilters);

        gantt.attachEvent("onBeforeTaskDisplay", function(id, task) {
            const taskName = task.text.toLowerCase();
            const filterValue = filterInput.value.toLowerCase();
            const assigneeValue = assigneeFilter.value;
            const nameMatch = taskName.includes(filterValue);
            const assigneeMatch = !assigneeValue || (task.assignee === assigneeValue);
            return nameMatch && assigneeMatch;
        });
        
        gantt.attachEvent("onLoadEnd", function(){
            const tasks = gantt.getTaskByTime();
            const assignees = new Set();
            tasks.forEach(task => { if(task.assignee) assignees.add(task.assignee); });
            const currentSelected = assigneeFilter.value;
            assigneeFilter.innerHTML = "<option value=''>전체</option>";
            assignees.forEach(assignee => {
                const selected = assignee === currentSelected ? " selected" : "";
                assigneeFilter.innerHTML += `<option value="${assignee}"${selected}>${assignee}</option>`;
            });
        });
        
        document.getElementById('setBaselineBtn').addEventListener('click', async () => {
            const name = prompt("베이스라인 이름을 입력하세요:", `Baseline ${new Date().toLocaleDateString()}`);
            if (name) {
                gantt.message(`'${name}' 베이스라인 저장 중...`);
                await fetch('/api/baselines', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({name: name}) });
                gantt.message({text: "베이스라인이 성공적으로 저장되었습니다.", expire: 3000});
                loadBaselines();
            }
        });
        
        const baselineSelect = document.getElementById('compareBaselineSelect');
        baselineSelect.addEventListener('change', () => {
            gantt.clearAll();
            gantt.load(`/api/data?baseline_id=${baselineSelect.value}`);
        });

        async function loadBaselines() {
            try {
                const response = await fetch('/api/baselines');
                if (!response.ok) throw new Error('Failed to load baselines');
                const baselines = await response.json();
                baselineSelect.innerHTML = '<option value="">베이스라인 비교 안 함</option>';
                baselines.forEach(b => {
                    baselineSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
                });
            } catch (error) {
                gantt.message({type: "error", text: "베이스라인 목록을 불러오는데 실패했습니다."});
            }
        }
        
        loadBaselines();
    </script>
</body>
</html>